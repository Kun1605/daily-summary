## Zookeeper Watch 机制

Zookeeper 客户端在数据节点上设置监视，则当数据节点发生变化时，客户端会收到提醒。

ZooKeeper 中的各种读请求，如 getDate()，getChildren()，和 exists()，都可以选择加"监视点"(watch)。

"监视点"指的是一种一次性的触发器(trigger)，当受监视的数据发生变化时，该触发器会通知客户端。

**监视机制有三个关键点：**
1. "监视点"是一次性的，当触发过一次之后，除非重新设置，新的数据变化不会提醒客户端。
2. "监视点"将数据改变的通知客户端。如果数据改变是客户端A引起的，不能保证"监视点"通知事件会在引发数据修改的函数返回前到达客户端A。
3. 对于"监视点"，ZooKeeper 有如下保证：客户端一定是在接收到"监视"事件（watch event）之后才接收到数据的改变信息。

"监视点"保留在 ZooKeeper 服务器上，则当客户端连接到新的 ZooKeeper 服务器上时，所有需要被触发的相关"监视点"都会被触发。当客户端断线后重连，
与它的相关的"监视点"都会自动重新注册，这对客户端来说是透明的。在以下情况，"监视点"会被错过：客户端 B 设置了关于节点A存在性的"监视点"，但 B 断线了，
在 B 断线过程中节点 A 被创建又被删除。此时，B 再连线后不知道 A 节点曾经被创建过。

**ZooKeeper 的"监视"机制保证以下几点：**
1. "监视"事件的触发顺序和事件的分发顺序一致
2. 客户端将先接收到"监视"事件，然后才收到新的数据
3. "监视"事件触发的顺序与 ZooKeeper 服务器上数据变化的顺序一致

**关于 ZooKeeper"监视"机制的注意点：**
1. "监视点"是一次性的
2. 由于"监视点"是一次性的，而且，从接收到"监视"事件到设置新"监视点"是有延时的，所以客户端可能监控不到数据的所有变化。
3. 一个监控对象，只会被相关的通知触发一次。如果一个客户端设置了关于某个数据点 exists 和 getData 的监控，则当该数据被删除的时候，只会触发"文件被删除"的
通知。
4. 当客户端断开与服务器的连接时，客户端不再能收到"监视"事件，直到重新获得连接。所以关于 Session 的信息将被发送给所有 ZooKeeper 服务器。由于当连接断开时收不到"监视"，所以在这种情况下，模块行为需要容错方面的设计。