## ZooKeeper一致性原理

### ZooKeeper 运行模式

ZooKeeper 服务有两种不同的运行模式。

一种是"独立模式"(standalone mode)，即只有一个 ZooKeeper 服务器。这种模式较为简单，比较适合于测试环境，甚至可以在单元测试中采用，但是不能保证高可用性和恢复性。

在生产环境中的 ZooKeeper 通常以"复制模式"(replicated mode)运行于一个计算机集群上，这个计算机集群被称为一个"集合体"(ensemble)。

![](../../images/zk%20集群.png)

ZooKeeper 通过复制来实现高可用性，只要集合体中半数以上的机器处于可用状态，它就能够提供服务。

例如，在一个有5个节点的集合体中，每个 Follower 节点的数据都是 Leader 节点数据的副本，也就是说每个节点的数据视图都是一样的，这样就可以有五个节点
提供 ZooKeeper 服务。并且集合体中任意2台机器出现故障，都可以保证服务继续，因为剩下的3台机器超过了半数。

`注意，6个节点的集合体也只能够容忍2台机器出现故障，因为如果3台机器出现故障，剩下的3台机器没有超过集合体的半数。出于这个原因，一个集合体通常包含奇数台机器。`

从概念上来说，ZooKeeper 所做的就是确保对 Znode 树的每一个修改都会被复制到集合体中超过半数的机器上。如果少于半数的机器出现故障，则最少有一台机器会保存最新的状态，
那么这台机器就是 Leader。其余的副本最终也会更新到这个状态。如果 Leader 挂了，由于其他机器保存了 Leader 的副本，那就可以从中选出一台机器作为新的 Leader 继续提供服务。

### ZooKeeper 的读写机制

Zookeeper 集群是一个由多个 Server 组成的集群，该集群有一个 Leader，多个 Follower。

客户端可以连接任意 ZooKeeper 服务节点来读写数据，如下图所示。

![](../../images/zk%20集群服务.png)

ZK 集群中每个 Server，都保存一份数据副本。Zookeeper 使用简单的同步策略，通过以下两条基本保证来实现数据的一致性：
1. 全局串行化所有的写操作
2. 保证同一客户端的指令被FIFO执行（以及消息通知的FIFO）

所有的读请求由 Zk Server 本地响应，所有的更新请求将转发给 Leader，由 Leader 实施。